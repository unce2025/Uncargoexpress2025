<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shipment Admin Panel - United Nation Cargo Express</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #002147;
    }

    form {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background-color: #002147;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #003366;
    }

    .section {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <h1>Admin Panel - United Nation Cargo Express</h1>

  <!-- Search Form -->
  <form id="searchForm">
    <input type="text" id="trackingSearch" placeholder="Enter Tracking Number to Search" required />
    <button type="submit">Search Shipment</button>
  </form>

  <!-- Main Shipment Form -->
  <form id="shipmentForm">
    <div class="section">
      <input type="text" id="TrackingNumber" name="TrackingNumber" placeholder="Tracking Number" required />
      <input type="text" id="Status" name="Status" placeholder="Status" required />
      <input type="text" id="ShipperName" name="ShipperName" placeholder="Shipper Name" />
      <input type="text" id="ShipperPhone" name="ShipperPhone" placeholder="Shipper Phone" />
      <input type="text" id="ShipperAddress" name="ShipperAddress" placeholder="Shipper Address" />
      <input type="email" id="ShipperEmail" name="ShipperEmail" placeholder="Shipper Email" />
      <input type="text" id="ReceiverName" name="ReceiverName" placeholder="Receiver Name" />
      <input type="text" id="ReceiverPhone" name="ReceiverPhone" placeholder="Receiver Phone" />
      <input type="text" id="ReceiverAddress" name="ReceiverAddress" placeholder="Receiver Address" />
      <input type="email" id="ReceiverEmail" name="ReceiverEmail" placeholder="Receiver Email" />
      <input type="date" id="EstimatedDeliveryDate" name="EstimatedDeliveryDate" placeholder="Estimated Delivery Date" />
      <input type="date" id="ShippedDate" name="ShippedDate" placeholder="Shipped Date" />
      <input type="text" id="FlightNumber" name="FlightNumber" placeholder="Flight Number" />
      <input type="text" id="PackageWeight" name="PackageWeight" placeholder="Package Weight (e.g., 2.5 kg)" />
      <input type="text" id="Mode" name="Mode" placeholder="Mode (e.g., Air-Freight)" />
      <input type="text" id="Product" name="Product" placeholder="Product" />
      <input type="number" id="Quantity" name="Quantity" placeholder="Quantity" />
      <input type="text" id="Payment" name="Payment" placeholder="Payment Method" />
      <input type="text" id="TotalFreight" name="TotalFreight" placeholder="Total Freight (e.g., $320)" />
    </div>

    <div class="section">
      <label for="log">Log (JSON format)</label>
      <textarea id="log" name="log" rows="8" placeholder='[{"date": "...", "description": "..."}]'></textarea>

      <label for="history">History (JSON format)</label>
      <textarea id="history" name="history" rows="10" placeholder='[{"date": "...", "location": "...", "status": "...", "updatedBy": "...", "remarks": "..."}]'></textarea>
    </div>

    <button type="submit">Save Shipment</button>
  </form>

<script>
const PROXY_URL = 'https://script.google.com/macros/s/AKfycbxjKoofO7d6UppF6YUWD8NDG6suTrCycEy1rHj9bXqBdOaFKgJcSG9X4jfYc0Syjpcc/exec';

const searchForm = document.getElementById('searchForm');
const shipmentForm = document.getElementById('shipmentForm');

function formatDateForInput(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return ''; // fallback if invalid date
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Search shipment by tracking number
searchForm.addEventListener('submit', async e => {
  e.preventDefault();
  const trackingNumber = document.getElementById('trackingSearch').value.trim();
  if (!trackingNumber) return alert("Enter a tracking number");

  try {
    const res = await fetch(`${PROXY_URL}?tracking=${encodeURIComponent(trackingNumber)}`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();

    if (data.shipment) {
      populateForm(data.shipment);
    } else {
      alert("Shipment not found");
      shipmentForm.reset();
    }
  } catch (err) {
    alert("Error: " + err.message);
  }
});

// Submit shipment form (add or update shipment)
shipmentForm.addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(shipmentForm);
  const shipment = {};
  formData.forEach((val, key) => shipment[key] = val.trim());

  if (!shipment.TrackingNumber) {
    return alert("Tracking Number is required");
  }

  // Parse JSON safely
  try {
    shipment.log = shipment.log ? JSON.parse(shipment.log) : [];
  } catch {
    return alert("Invalid JSON format in log field");
  }

  try {
    shipment.history = shipment.history ? JSON.parse(shipment.history) : [];
  } catch {
    return alert("Invalid JSON format in history field");
  }

  // Format date fields to "YYYY-MM-DD" strings to satisfy input type="date"
  shipment.EstimatedDeliveryDate = formatDateForInput(shipment.EstimatedDeliveryDate);
  shipment.ShippedDate = formatDateForInput(shipment.ShippedDate);

  try {
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ shipment })
    });

    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const result = await res.json();

    if (result.success) {
      alert("Shipment saved successfully!");
      shipmentForm.reset();
    } else {
      alert("Error saving shipment: " + (result.message || "Unknown error"));
    }
  } catch (err) {
    alert("Request failed: " + err.message);
  }
});

function populateForm(data) {
  for (const key in data) {
    const el = document.getElementById(key);
    if (el) {
      if (key === 'log' || key === 'history') {
        el.value = JSON.stringify(data[key], null, 2);
      } else if (key === 'EstimatedDeliveryDate' || key === 'ShippedDate') {
        el.value = formatDateForInput(data[key]);
      } else {
        el.value = data[key];
      }
    }
  }
}

</script>

  
</body>
</html>
