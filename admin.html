<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shipment Admin Panel</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 10px; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, select, textarea, button { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  .inline-inputs { display: flex; gap: 10px; }
  .inline-inputs > * { flex: 1; }
  .list-container { border: 1px solid #ccc; padding: 10px; margin-top: 5px; max-height: 200px; overflow-y: auto; }
  .list-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; background: #f9f9f9; padding: 5px 8px; border-radius: 4px; }
  .list-item button { background: #d9534f; color: white; border: none; padding: 2px 8px; cursor: pointer; border-radius: 4px; }
  .add-btn { margin-top: 5px; }
  .success-msg { color: green; margin-top: 10px; }
  .error-msg { color: red; margin-top: 10px; }
</style>
</head>
<body>

<h1>Shipment Admin Panel</h1>

<!-- Search by tracking number -->
<label for="searchTracking">Search by Tracking Number</label>
<div class="inline-inputs">
  <input type="text" id="searchTracking" placeholder="Enter tracking number" />
  <button onclick="searchShipment()">Search</button>
</div>

<form id="shipmentForm" onsubmit="return saveShipment(event)">

  <!-- Shipment basic fields -->
  <label for="TrackingNumber">Tracking Number</label>
  <input type="text" id="TrackingNumber" name="TrackingNumber" required />

  <label for="Status">Status</label>
  <input type="text" id="Status" name="Status" />

  <label for="ShipperName">Shipper Name</label>
  <input type="text" id="ShipperName" name="ShipperName" />

  <label for="ShipperPhone">Shipper Phone</label>
  <input type="text" id="ShipperPhone" name="ShipperPhone" />

  <label for="ShipperAddress">Shipper Address</label>
  <textarea id="ShipperAddress" name="ShipperAddress"></textarea>

  <label for="ShipperEmail">Shipper Email</label>
  <input type="email" id="ShipperEmail" name="ShipperEmail" />

  <label for="ReceiverName">Receiver Name</label>
  <input type="text" id="ReceiverName" name="ReceiverName" />

  <label for="ReceiverPhone">Receiver Phone</label>
  <input type="text" id="ReceiverPhone" name="ReceiverPhone" />

  <label for="ReceiverAddress">Receiver Address</label>
  <textarea id="ReceiverAddress" name="ReceiverAddress"></textarea>

  <label for="ReceiverEmail">Receiver Email</label>
  <input type="email" id="ReceiverEmail" name="ReceiverEmail" />

  <label for="EstimatedDeliveryDate">Estimated Delivery Date</label>
  <input type="date" id="EstimatedDeliveryDate" name="EstimatedDeliveryDate" />

  <label for="ShippedDate">Shipped Date</label>
  <input type="date" id="ShippedDate" name="ShippedDate" />

  <label for="PickUpTime">Pick Up Time</label>
  <input type="time" id="PickUpTime" name="PickUpTime" />

  <label for="Departure">Departure</label>
  <input type="text" id="Departure" name="Departure" />

  <label for="Mode">Mode</label>
  <input type="text" id="Mode" name="Mode" />

  <label for="Product">Product</label>
  <input type="text" id="Product" name="Product" />

  <label for="Quantity">Quantity</label>
  <input type="number" id="Quantity" name="Quantity" min="0" />

  <label for="Payment">Payment</label>
  <input type="text" id="Payment" name="Payment" />

  <label for="TotalFreight">Total Freight</label>
  <input type="number" id="TotalFreight" name="TotalFreight" min="0" step="0.01" />

  <!-- Log entries UI -->
  <div>
    <h3>Shipment Log</h3>
    <div class="inline-inputs">
      <input type="date" id="logDate" />
      <input type="text" id="logDesc" placeholder="Log description" />
      <button type="button" class="add-btn" onclick="addLogEntry()">Add Log Entry</button>
    </div>
    <div id="logList" class="list-container"></div>
    <textarea id="log" name="log" style="display:none;"></textarea>
  </div>

  <!-- History entries UI -->
  <div>
    <h3>Shipment History</h3>
    <div class="inline-inputs">
      <input type="text" id="historyDesc" placeholder="History entry description" />
      <button type="button" class="add-btn" onclick="addHistoryEntry()">Add History Entry</button>
    </div>
    <div id="historyList" class="list-container"></div>
    <textarea id="history" name="history" style="display:none;"></textarea>
  </div>

  <!-- Packages field as JSON textarea (optional) -->
  <label for="packages">Packages (JSON format)</label>
  <textarea id="packages" name="packages" rows="4" placeholder='[{"type":"Box","weight":10}]'></textarea>

  <button type="submit" style="margin-top:20px;">Save Shipment</button>
</form>

<div id="msg" style="margin-top:20px;"></div>

<script>
  // Hold log and history as arrays
  const logEntries = [];
  const historyEntries = [];

  // Render log list
  function renderLog() {
    const logList = document.getElementById('logList');
    logList.innerHTML = '';
    logEntries.forEach((entry, index) => {
      const li = document.createElement('div');
      li.className = 'list-item';
      li.textContent = `${entry.date} - ${entry.desc}`;
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => {
        logEntries.splice(index, 1);
        renderLog();
      };
      li.appendChild(removeBtn);
      logList.appendChild(li);
    });
    document.getElementById('log').value = JSON.stringify(logEntries);
  }

  // Render history list
  function renderHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    historyEntries.forEach((desc, index) => {
      const li = document.createElement('div');
      li.className = 'list-item';
      li.textContent = desc;
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => {
        historyEntries.splice(index, 1);
        renderHistory();
      };
      li.appendChild(removeBtn);
      historyList.appendChild(li);
    });
    document.getElementById('history').value = JSON.stringify(historyEntries);
  }

  // Add log entry from inputs
  function addLogEntry() {
    const dateInput = document.getElementById('logDate');
    const descInput = document.getElementById('logDesc');
    if (!dateInput.value || !descInput.value.trim()) {
      alert('Please enter both date and log description.');
      return;
    }
    logEntries.push({ date: dateInput.value, desc: descInput.value.trim() });
    dateInput.value = '';
    descInput.value = '';
    renderLog();
  }

  // Add history entry from input
  function addHistoryEntry() {
    const descInput = document.getElementById('historyDesc');
    if (!descInput.value.trim()) {
      alert('Please enter a history description.');
      return;
    }
    historyEntries.push(descInput.value.trim());
    descInput.value = '';
    renderHistory();
  }

  // Load shipment data into form including logs and history
  function loadShipment(shipment) {
    if (!shipment) return;
    const fields = [
      "TrackingNumber","Status","ShipperName","ShipperPhone","ShipperAddress","ShipperEmail",
      "ReceiverName","ReceiverPhone","ReceiverAddress","ReceiverEmail",
      "EstimatedDeliveryDate","ShippedDate","PickUpTime","Departure","Mode",
      "Product","Quantity","Payment","TotalFreight","packages"
    ];
    fields.forEach(f => {
      const el = document.getElementById(f);
      if (el) {
        if (f === "EstimatedDeliveryDate" || f === "ShippedDate") {
          // Dates from backend may be MM/dd/yyyy, convert to yyyy-MM-dd for input
          el.value = shipment[f] ? formatDateForInput(shipment[f]) : '';
        } else {
          el.value = shipment[f] || '';
        }
      }
    });

    // Load logs and history JSON
    loadLogFromJSON(shipment.log || '[]');
    loadHistoryFromJSON(shipment.history || '[]');
  }

  // Format MM/dd/yyyy to yyyy-MM-dd for <input type="date">
  function formatDateForInput(dateStr) {
    const parts = dateStr.split('/');
    if(parts.length === 3){
      return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
    }
    return dateStr;
  }

  // Parse and load logs JSON into UI
  function loadLogFromJSON(jsonStr) {
    try {
      const arr = JSON.parse(jsonStr);
      if (Array.isArray(arr)) {
        logEntries.splice(0, logEntries.length, ...arr);
        renderLog();
      } else {
        logEntries.splice(0, logEntries.length);
        renderLog();
      }
    } catch (e) {
      logEntries.splice(0, logEntries.length);
      renderLog();
    }
  }

  // Parse and load history JSON into UI
  function loadHistoryFromJSON(jsonStr) {
    try {
      const arr = JSON.parse(jsonStr);
      if (Array.isArray(arr)) {
        historyEntries.splice(0, historyEntries.length, ...arr);
        renderHistory();
      } else {
        historyEntries.splice(0, historyEntries.length);
        renderHistory();
      }
    } catch (e) {
      historyEntries.splice(0, historyEntries.length);
      renderHistory();
    }
  }

  // Search shipment by tracking number
  async function searchShipment() {
    const tracking = document.getElementById('searchTracking').value.trim();
    if (!tracking) {
      alert('Please enter a tracking number to search.');
      return;
    }
    showMessage('Searching shipment...', false);
    try {
      const response = await fetch(`https://script.google.com/macros/s/AKfycbxaJNPDvBfowAq9OUojrSm4zi2l1HcUUbYKkJprfeOZUfvIDRjYuiCKK4j2ShANdOxK/exec?tracking=${encodeURIComponent(tracking)}`);
      const data = await response.json();
      if (data.success && data.shipment) {
        loadShipment(data.shipment);
        showMessage('Shipment loaded.', false);
      } else {
        clearForm();
        showMessage('Shipment not found.', true);
      }
    } catch (err) {
      showMessage('Error fetching shipment: ' + err.message, true);
    }
  }

  // Clear form fields and lists
  function clearForm() {
    document.getElementById('shipmentForm').reset();
    logEntries.splice(0, logEntries.length);
    historyEntries.splice(0, historyEntries.length);
    renderLog();
    renderHistory();
  }

  // Show success/error message
  function showMessage(msg, isError) {
    const msgEl = document.getElementById('msg');
    msgEl.textContent = msg;
    msgEl.className = isError ? 'error-msg' : 'success-msg';
  }

  // Save shipment form data
  async function saveShipment(event) {
    event.preventDefault();

    const form = document.getElementById('shipmentForm');

    // Gather all form data into object
    const formData = new FormData(form);
    const shipment = {};
    for (const [key, value] of formData.entries()) {
      shipment[key] = value;
    }

    // Parse quantity and total freight as numbers
    if (shipment.Quantity) shipment.Quantity = Number(shipment.Quantity);
    if (shipment.TotalFreight) shipment.TotalFreight = Number(shipment.TotalFreight);

    // Send POST to Google Apps Script
    showMessage('Saving shipment...', false);

    try {
      const response = await fetch('YOUR_GOOGLE_SCRIPT_URL', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ shipment })
      });
      const data = await response.json();

      if (data.success) {
        showMessage(data.message || 'Shipment saved successfully.', false);
        // Optionally clear form or keep data
      } else {
        showMessage(data.message || 'Error saving shipment.', true);
      }
    } catch (err) {
      showMessage('Error saving shipment: ' + err.message, true);
    }
  }
</script>

</body>
</html>
