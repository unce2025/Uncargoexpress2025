<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - United Nation Cargo Express</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    color: #022b54;
    margin: 20px;
  }
  h1, h3 {
    color: #022b54;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input[type="text"], input[type="email"], input[type="date"], input[type="time"], select {
    width: 100%;
    padding: 7px;
    margin-top: 5px;
    box-sizing: border-box;
    border: 1px solid #022b54;
    border-radius: 4px;
  }
  button {
    margin-top: 15px;
    padding: 10px 15px;
    background-color: #022b54;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background-color: #014a8f;
  }
  .entry-group {
    margin-bottom: 8px;
    border: 1px solid #022b54;
    padding: 8px;
    border-radius: 4px;
    background: white;
  }
  .entry-group > input {
    margin-right: 5px;
  }
  .entry-group button {
    background: #b22222;
  }
  .flex-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex-row > * {
    flex: 1;
  }
</style>
</head>
<body>

<h1>Admin Panel - United Nation Cargo Express</h1>

<!-- Search Section -->
<div>
  <label for="searchTrackingNumber">Search Tracking Number:</label>
  <input type="text" id="searchTrackingNumber" placeholder="Enter tracking number to search" />
  <button onclick="searchShipment()">Search</button>
  <button onclick="clearForm()">Clear Form</button>
</div>

<hr/>

<!-- Shipment Form -->
<form id="shipmentForm" onsubmit="event.preventDefault(); saveShipment();">

  <!-- Basic shipment details -->
  <label for="TrackingNumber">Tracking Number *</label>
  <input type="text" id="TrackingNumber" required />

  <label for="Status">Status</label>
  <input type="text" id="Status" />

  <label for="ShipperName">Shipper Name</label>
  <input type="text" id="ShipperName" />

  <label for="ShipperPhone">Shipper Phone</label>
  <input type="text" id="ShipperPhone" />

  <label for="ShipperAddress">Shipper Address</label>
  <input type="text" id="ShipperAddress" />

  <label for="ShipperEmail">Shipper Email</label>
  <input type="email" id="ShipperEmail" />

  <label for="ReceiverName">Receiver Name</label>
  <input type="text" id="ReceiverName" />

  <label for="ReceiverPhone">Receiver Phone</label>
  <input type="text" id="ReceiverPhone" />

  <label for="ReceiverAddress">Receiver Address</label>
  <input type="text" id="ReceiverAddress" />

  <label for="ReceiverEmail">Receiver Email</label>
  <input type="email" id="ReceiverEmail" />

  <label for="EstimatedDeliveryDate">Estimated Delivery Date</label>
  <input type="date" id="EstimatedDeliveryDate" />

  <label for="ShippedDate">Shipped Date</label>
  <input type="date" id="ShippedDate" />

  <label for="PickUpTime">Pick Up Time</label>
  <input type="time" id="PickUpTime" />

  <label for="Departure">Departure</label>
  <input type="text" id="Departure" />

  <label for="Mode">Mode</label>
  <input type="text" id="Mode" />

  <label for="Product">Product</label>
  <input type="text" id="Product" />

  <label for="Quantity">Quantity</label>
  <input type="text" id="Quantity" />

  <label for="Payment">Payment</label>
  <input type="text" id="Payment" />

  <label for="TotalFreight">Total Freight</label>
  <input type="text" id="TotalFreight" />

  <hr/>

  <!-- Log Entries -->
  <h3>Log Entries</h3>
  <div id="logEntries"></div>
  <button type="button" onclick="addLogEntry()">Add Log Entry</button>

  <hr/>

  <!-- History Entries -->
  <h3>History Entries</h3>
  <div id="historyEntries"></div>
  <button type="button" onclick="addHistoryEntry()">Add History Entry</button>

  <hr/>

  <button type="submit">Save Shipment</button>
</form>

<script>
// Paste your Google Apps Script Web App URL here:
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPDSYFvy0iburNNHhbsQ6sEPVOW_EMDSLh1mP9A_nxCZ_S3IrVuAvnHaV5rgzJMv6k/exec';

// Search shipment by tracking number
async function searchShipment() {
  const trackingNumber = document.getElementById('trackingNumber').value.trim();
  if (!trackingNumber) {
    alert('Please enter a tracking number to search.');
    return;
  }

  try {
    const response = await fetch(`${SCRIPT_URL}?trackingNumber=${encodeURIComponent(trackingNumber)}`);
    if (!response.ok) throw new Error('Shipment not found');
    const result = await response.json();

    if (result.shipment) {
      fillForm(result.shipment);
      alert('Shipment loaded. You can now edit and save.');
    } else {
      alert('No shipment found with that tracking number.');
      clearForm();
    }
  } catch (error) {
    alert('Error fetching shipment: ' + error.message);
    clearForm();
  }
}

// Fill form inputs with shipment data
function fillForm(data) {
  // Basic fields
  document.getElementById('trackingNumber').value = data.TrackingNumber || '';
  document.getElementById('status').value = data.Status || '';
  document.getElementById('shipperName').value = data.ShipperName || '';
  document.getElementById('shipperPhone').value = data.ShipperPhone || '';
  document.getElementById('shipperAddress').value = data.ShipperAddress || '';
  document.getElementById('shipperEmail').value = data.ShipperEmail || '';
  document.getElementById('receiverName').value = data.ReceiverName || '';
  document.getElementById('receiverPhone').value = data.ReceiverPhone || '';
  document.getElementById('receiverAddress').value = data.ReceiverAddress || '';
  document.getElementById('receiverEmail').value = data.ReceiverEmail || '';
  document.getElementById('estimatedDeliveryDate').value = data.EstimatedDeliveryDate || '';
  document.getElementById('shippedDate').value = data.ShippedDate || '';
  document.getElementById('pickUpTime').value = data.PickUpTime || '';
  document.getElementById('departure').value = data.Departure || '';
  document.getElementById('mode').value = data.Mode || '';
  document.getElementById('product').value = data.Product || '';
  document.getElementById('quantity').value = data.Quantity || '';
  document.getElementById('payment').value = data.Payment || '';
  document.getElementById('totalFreight').value = data.TotalFreight || '';

  // Format and show log and history as human-friendly text
  document.getElementById('log').value = formatLogOrHistory(data.log);
  document.getElementById('history').value = formatLogOrHistory(data.history);
}

// Format log or history string to readable text for clients
function formatLogOrHistory(text) {
  if (!text) return '';
  try {
    // Assuming log/history stored as JSON array of entries
    const entries = JSON.parse(text);
    if (!Array.isArray(entries)) return text;

    return entries
      .map(entry => {
        // Customize keys depending on your structure, example:
        let parts = [];
        if (entry.Date) parts.push(`Date: ${entry.Date}`);
        if (entry.Time) parts.push(`Time: ${entry.Time}`);
        if (entry.Location) parts.push(`Location: ${entry.Location}`);
        if (entry.Status) parts.push(`Status: ${entry.Status}`);
        if (entry.UpdatedBy) parts.push(`Updated By: ${entry.UpdatedBy}`);
        if (entry.Remarks) parts.push(`Remarks: ${entry.Remarks}`);
        return parts.join(', ');
      })
      .join('\n');
  } catch {
    // If not JSON, just return raw text
    return text;
  }
}

// Clear all form fields
function clearForm() {
  const fields = document.querySelectorAll('#adminForm input, #adminForm textarea');
  fields.forEach(f => (f.value = ''));
}

// Save (Add or Update) shipment
async function saveShipment() {
  const data = {
    TrackingNumber: document.getElementById('trackingNumber').value.trim(),
    Status: document.getElementById('status').value.trim(),
    ShipperName: document.getElementById('shipperName').value.trim(),
    ShipperPhone: document.getElementById('shipperPhone').value.trim(),
    ShipperAddress: document.getElementById('shipperAddress').value.trim(),
    ShipperEmail: document.getElementById('shipperEmail').value.trim(),
    ReceiverName: document.getElementById('receiverName').value.trim(),
    ReceiverPhone: document.getElementById('receiverPhone').value.trim(),
    ReceiverAddress: document.getElementById('receiverAddress').value.trim(),
    ReceiverEmail: document.getElementById('receiverEmail').value.trim(),
    EstimatedDeliveryDate: document.getElementById('estimatedDeliveryDate').value.trim(),
    ShippedDate: document.getElementById('shippedDate').value.trim(),
    PickUpTime: document.getElementById('pickUpTime').value.trim(),
    Departure: document.getElementById('departure').value.trim(),
    Mode: document.getElementById('mode').value.trim(),
    Product: document.getElementById('product').value.trim(),
    Quantity: document.getElementById('quantity').value.trim(),
    Payment: document.getElementById('payment').value.trim(),
    TotalFreight: document.getElementById('totalFreight').value.trim(),
    // Convert log/history back to JSON strings if possible
    log: tryParseLogHistory(document.getElementById('log').value),
    history: tryParseLogHistory(document.getElementById('history').value),
  };

  if (!data.TrackingNumber) {
    alert('Tracking number is required.');
    return;
  }

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data),
    });
    const result = await response.json();

    if (result.success) {
      alert('Shipment saved successfully.');
    } else {
      alert('Error saving shipment: ' + (result.message || 'Unknown error'));
    }
  } catch (error) {
    alert('Error saving shipment: ' + error.message);
  }
}

// Try to convert client-friendly text back to JSON string for storage
function tryParseLogHistory(text) {
  // Simple heuristic: if it looks like multiple lines with "Date: ...", convert to JSON entries
  const lines = text.trim().split('\n');
  if (lines.length === 0 || !lines[0].includes('Date:')) return text;

  const entries = lines.map(line => {
    const obj = {};
    const parts = line.split(',');
    parts.forEach(part => {
      const [key, ...rest] = part.trim().split(':');
      if (key && rest.length) {
        obj[key.trim()] = rest.join(':').trim();
      }
    });
    return obj;
  });

  return JSON.stringify(entries);
}

// Attach event listeners (assuming buttons have these IDs)
document.getElementById('searchBtn').addEventListener('click', searchShipment);
document.getElementById('saveBtn').addEventListener('click', saveShipment);
document.getElementById('newBtn').addEventListener('click', clearForm);


</script>

</body>
</html>
